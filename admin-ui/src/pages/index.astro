---
import Layout from '../layouts/Layout.astro';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../components/ui/card';
---

<Layout title="Dashboard - Caching Admin">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">Dashboard</h1>
    <div class="text-sm text-muted-foreground">
      Last updated: <span id="last-updated">Just now</span>
    </div>
  </div>
  
  <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4 mb-6">
    <Card>
      <CardHeader class="pb-2">
        <CardTitle class="text-sm font-medium">Cache Hit Rate</CardTitle>
      </CardHeader>
      <CardContent>
        <div class="text-2xl font-bold">84.5%</div>
        <p class="text-xs text-muted-foreground">+2.5% from last week</p>
      </CardContent>
    </Card>
    
    <Card>
      <CardHeader class="pb-2">
        <CardTitle class="text-sm font-medium">Total Requests</CardTitle>
      </CardHeader>
      <CardContent>
        <div class="text-2xl font-bold">1,245,678</div>
        <p class="text-xs text-muted-foreground">+12.3% from last week</p>
      </CardContent>
    </Card>
    
    <Card>
      <CardHeader class="pb-2">
        <CardTitle class="text-sm font-medium">Avg Response Time</CardTitle>
      </CardHeader>
      <CardContent>
        <div class="text-2xl font-bold">42ms</div>
        <p class="text-xs text-muted-foreground">-3ms from last week</p>
      </CardContent>
    </Card>
    
    <Card>
      <CardHeader class="pb-2">
        <CardTitle class="text-sm font-medium">API Status</CardTitle>
      </CardHeader>
      <CardContent>
        <div class="flex items-center">
          <div id="api-status-indicator" class="w-3 h-3 rounded-full bg-gray-300 mr-2"></div>
          <div id="api-status-text" class="text-lg font-medium">Checking...</div>
        </div>
        <p id="api-environment" class="text-xs text-muted-foreground mt-1"></p>
      </CardContent>
    </Card>
  </div>
  
  <div class="grid gap-4 md:grid-cols-2 mb-6">
    <Card>
      <CardHeader>
        <CardTitle>Cache Performance by Type</CardTitle>
        <CardDescription>Hit rate by asset type over the last 24 hours</CardDescription>
      </CardHeader>
      <CardContent>
        <div class="h-80 flex items-center justify-center bg-muted/20 rounded-md">
          <div class="text-muted-foreground">
            Chart will be rendered here with React component
          </div>
        </div>
      </CardContent>
    </Card>
    
    <Card>
      <CardHeader>
        <CardTitle>Response Time Trends</CardTitle>
        <CardDescription>Average response time over the last 7 days</CardDescription>
      </CardHeader>
      <CardContent>
        <div class="h-80 flex items-center justify-center bg-muted/20 rounded-md">
          <div class="text-muted-foreground">
            Chart will be rendered here with React component
          </div>
        </div>
      </CardContent>
    </Card>
  </div>
  
  <Card>
    <CardHeader>
      <CardTitle>Asset Type Performance</CardTitle>
      <CardDescription>Detailed performance metrics by asset type</CardDescription>
    </CardHeader>
    <CardContent>
      <div class="rounded-md border">
        <table class="w-full caption-bottom text-sm">
          <thead class="[&_tr]:border-b">
            <tr class="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted">
              <th class="h-12 px-4 text-left align-middle font-medium">Asset Type</th>
              <th class="h-12 px-4 text-left align-middle font-medium">Hit Rate</th>
              <th class="h-12 px-4 text-left align-middle font-medium">Avg Time</th>
              <th class="h-12 px-4 text-left align-middle font-medium">Requests</th>
              <th class="h-12 px-4 text-left align-middle font-medium">Tags</th>
            </tr>
          </thead>
          <tbody class="[&_tr:last-child]:border-0">
            <tr class="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted">
              <td class="p-4 align-middle">Image</td>
              <td class="p-4 align-middle">92.4%</td>
              <td class="p-4 align-middle">35ms</td>
              <td class="p-4 align-middle">456,789</td>
              <td class="p-4 align-middle">cf:type:image</td>
            </tr>
            <tr class="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted">
              <td class="p-4 align-middle">Video</td>
              <td class="p-4 align-middle">78.2%</td>
              <td class="p-4 align-middle">125ms</td>
              <td class="p-4 align-middle">123,456</td>
              <td class="p-4 align-middle">cf:type:video</td>
            </tr>
            <tr class="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted">
              <td class="p-4 align-middle">Frontend (JS/CSS)</td>
              <td class="p-4 align-middle">96.7%</td>
              <td class="p-4 align-middle">22ms</td>
              <td class="p-4 align-middle">345,678</td>
              <td class="p-4 align-middle">cf:type:frontend</td>
            </tr>
            <tr class="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted">
              <td class="p-4 align-middle">API</td>
              <td class="p-4 align-middle">65.3%</td>
              <td class="p-4 align-middle">85ms</td>
              <td class="p-4 align-middle">234,567</td>
              <td class="p-4 align-middle">cf:type:api</td>
            </tr>
            <tr class="transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted">
              <td class="p-4 align-middle">Manifest</td>
              <td class="p-4 align-middle">45.8%</td>
              <td class="p-4 align-middle">15ms</td>
              <td class="p-4 align-middle">56,789</td>
              <td class="p-4 align-middle">cf:type:manifest</td>
            </tr>
          </tbody>
        </table>
      </div>
    </CardContent>
  </Card>
</Layout>

<script>
  // Function to check API status
  async function checkApiStatus() {
    const statusIndicator = document.getElementById('api-status-indicator');
    const statusText = document.getElementById('api-status-text');
    const environmentEl = document.getElementById('api-environment');
    
    if (!statusIndicator || !statusText || !environmentEl) return;
    
    try {
      const response = await fetch('/api/status');
      
      if (response.ok) {
        const data = await response.json();
        
        if (data.success) {
          // Update status indicator
          statusIndicator.classList.remove('bg-gray-300', 'bg-red-500');
          statusIndicator.classList.add('bg-green-500');
          
          // Update status text
          statusText.textContent = 'Operational';
          
          // Update environment
          environmentEl.textContent = `Environment: ${data.data.environment}`;
          
          // Update last updated timestamp
          const lastUpdatedEl = document.getElementById('last-updated');
          if (lastUpdatedEl) {
            lastUpdatedEl.textContent = new Date().toLocaleTimeString();
          }
        } else {
          statusIndicator.classList.remove('bg-gray-300', 'bg-green-500');
          statusIndicator.classList.add('bg-red-500');
          statusText.textContent = 'API Error';
        }
      } else {
        statusIndicator.classList.remove('bg-gray-300', 'bg-green-500');
        statusIndicator.classList.add('bg-red-500');
        statusText.textContent = 'API Unavailable';
      }
    } catch (error) {
      statusIndicator.classList.remove('bg-gray-300', 'bg-green-500');
      statusIndicator.classList.add('bg-red-500');
      statusText.textContent = 'Connection Error';
      console.error('Error checking API status:', error);
    }
  }
  
  // Load asset types count from API
  async function loadAssetTypesCount() {
    try {
      const response = await fetch('/api/asset-types');
      
      if (response.ok) {
        const data = await response.json();
        
        if (data.success && data.data) {
          // Update a chart or table with the data if needed
          console.log(`Loaded ${data.data.length} asset types`);
        }
      }
    } catch (error) {
      console.error('Error loading asset types:', error);
    }
  }
  
  // Check API status when the page loads
  document.addEventListener('DOMContentLoaded', () => {
    checkApiStatus();
    loadAssetTypesCount();
  });
</script>